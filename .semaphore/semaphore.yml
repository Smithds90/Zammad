version: v1.0
name: Zammad CI
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004
auto_cancel:
  running:
    when: "true"
global_job_config:
  prologue:
    commands:
      - checkout
      - cache restore
      - sem-service start postgres 10 --username=zammad --password=zammad
      - sem-service start redis 5
      - sem-version ruby 3.1.3
      - sudo apt-get update
      - sudo apt-get install -y -f optipng jhead imagemagick libimlib2 openssl direnv shellcheck libimlib2-dev
      - echo '127.0.0.1 redis postgresql' | sudo tee -a /etc/hosts
      - rbenv rehash
      - bundle install --path vendor/bundle
      - yarn install
      - yarn cypress:install
      - cache store
      - bundle exec ruby .gitlab/configure_environment.rb
      - bundle exec rake zammad:db:init
  env_vars:
    - name: RAILS_ENV
      value: "test"
    - name: Z_LOCALES
      value: "en-us:de-de"
    - name: CI_SKIP_ASSETS_PRECOMPILE
      value: 'true'
    - name: CI_SKIP_DB_RESET
      value: 'true'
blocks:
  dependencies: []
  - name: Lint
    task:
      jobs:
        - name: Linting
          commands:
            - for FILE in i18n/*.pot i18n/*.po; do echo "Checking $FILE"; msgfmt -o /dev/null -c "$FILE"; done
            - bundle exec rails generate zammad:translation_catalog --check
            - bundle exec brakeman -o /dev/stdout -o tmp/brakeman-report.html
            - bundle exec rails zeitwerk:check
            - .gitlab/check_graphql_api_consistency.sh
            - bundle exec .rubocop/validate_todos.rb
            - bundle exec rubocop --parallel
            - yarn lint:css
            - yarn lint

  - name: RSpec
    dependencies: []
    task:
      jobs:
        - name: Tests
          parallelism: 4
          commands:
            - gem install semaphore_test_boosters
            - bundle exec rake assets:precompile
            - yarn test
            - yarn test:ci:ct
            - TEST_BOOSTERS_RSPEC_TEST_EXCLUDE_PATTERN='--exclude-pattern "spec/system/**/*_spec.rb"' rspec_booster --job $SEMAPHORE_JOB_INDEX/$SEMAPHORE_JOB_COUNT -t ~searchindex -t ~integration -t ~required_envs
            - bundle exec rake zammad:db:reset
            - bundle exec rake test:units
