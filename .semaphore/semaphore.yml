version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Build Cache
    task:
      jobs:
        - name: Rspec core
          commands:
            - checkout
            - sudo apt-get update
            - sudo apt-get install -y -f optipng jhead imagemagick libimlib2 openssl direnv shellcheck libimlib2-dev
            - sem-service start postgres 10 --username=zammad --password=zammad
            - sem-service start redis 6.2
            - sem-version ruby 3.1.3
            - rbenv rehash
            - cache clear
            - bundle install --path vendor/bundle
            - gem install semaphore_test_boosters
            - yarn install
            - cache store

  - name: Run tests
    task:
      env_vars:
        - name: ENABLE_EXPERIMENTAL_MOBILE_FRONTEND
          value: 'false'
      prologue:
        commands:
          - checkout
          - sudo apt-get update
          - sudo apt-get install -y -f optipng jhead imagemagick libimlib2 direnv shellcheck libimlib2-dev
          - echo '127.0.0.1 redis postgresql' | sudo tee -a /etc/hosts
          - sem-service start postgres 10 --username=zammad --password=zammad
          - sem-version ruby 3.1.3
          - rbenv rehash
          - cache restore
          - bundle install --path vendor/bundle
          - gem install semaphore_test_boosters
          - yarn install
          - yarn cypress:install
          - bundle exec ruby .gitlab/configure_environment.rb

      jobs:
        - name: Lint
          commands:
            - for FILE in i18n/*.pot i18n/*.po; do echo "Checking $FILE"; msgfmt -o /dev/null -c "$FILE"; done
            - bundle exec rails generate zammad:translation_catalog --check
            - bundle exec brakeman -o /dev/stdout -o tmp/brakeman-report.html
            - bundle exec rails zeitwerk:check
            - .gitlab/check_graphql_api_consistency.sh
            - bundle exec .rubocop/validate_todos.rb
            - bundle exec rubocop --parallel
            - yarn lint:css
            - yarn lint

        - name: Yarn
          commands:
            - echo "Checking assets generation..."
            - bundle exec rake assets:precompile
            - echo "Running front end tests..."
            - yarn test
            - yarn test:ci:ct

        - name: Rspec
          commands:
            - echo "Checking assets generation..."
            - bundle exec rake assets:precompile
            - echo "Running basic rspec tests..."
            - bundle exec rake zammad:db:init
            - bundle exec rspec --exclude-pattern "spec/system/**/*_spec.rb" -t ~searchindex -t ~integration -t ~required_envs
            - echo "Running basic minitest tests..."
            - bundle exec rake zammad:db:reset
            - bundle exec rake test:units
            - ruby -I test/ test/integration/object_manager_test.rb
